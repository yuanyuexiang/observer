# 视频流检测功能 - 开发说明

## 🎯 功能目标

根据用户需求，扩展工具检测系统支持多种数据源：
- **静态图片** - 原有功能保持不变
- **视频文件** - 按时间间隔自动采样检测
- **实时摄像头** - 每10秒自动检测 + 手动触发检测

## ✨ 新增功能

### 1. 🎥 VideoToolDetector 类
**文件**: `video_detector.py`

#### 核心功能
- **多数据源支持**: 自动识别图片、视频文件、摄像头设备
- **智能帧采样**: 按时间间隔提取关键帧，避免重复检测
- **实时监控**: OpenCV窗口显示实时画面，支持交互控制
- **专业报告**: 每次检测都生成完整的状态报告

#### 关键方法
```python
def setup_detectors()              # 初始化检测组件
def detect_frame(frame, source)    # 单帧检测核心逻辑
def process_video_file(path)       # 视频文件批量处理
def process_camera_stream(id)      # 摄像头实时监控
```

### 2. 🖥️ CLI命令扩展
**文件**: `simple_cli.py`

#### 新增video命令
```bash
python simple_cli.py video <source> [options]
```

#### 参数说明
- `<source>`: 数据源
  - `0, 1, 2...` - 摄像头设备ID
  - `video.mp4` - 视频文件路径
  - `image.jpg` - 静态图片路径
- `--interval <seconds>` - 检测间隔（默认10秒）
- `--max-frames <number>` - 最大检测帧数（仅视频文件）

## 📊 使用场景

### 🔧 工业应用
1. **生产线监控**
   ```bash
   python simple_cli.py video 0 --interval 30
   ```
   - 每30秒检测一次工具状态
   - 适合连续生产监控

2. **质量检查记录**
   ```bash
   python simple_cli.py video inspection.mp4 --max-frames 10
   ```
   - 从录像中提取关键帧检测
   - 生成质量检查报告

3. **班次交接**
   ```bash
   python simple_cli.py video workspace.jpg
   ```
   - 快速检查当前工具状态
   - 生成交接记录

### 📱 开发测试
1. **快速调试**
   ```bash
   python simple_cli.py video 0 --interval 5
   ```
   - 5秒间隔快速测试

2. **批量验证**
   ```bash
   python simple_cli.py video test_video.mp4
   ```
   - 验证算法在不同场景下的表现

## 🎮 交互控制

### 实时监控模式
- **自动检测**: 每N秒自动触发
- **手动检测**: 按 `d` 键立即检测
- **退出程序**: 按 `q` 键安全退出
- **状态显示**: 窗口标题实时显示完整性

### 视频文件模式
- **进度显示**: 实时显示处理进度
- **智能采样**: 按时间间隔采样，避免冗余
- **批量报告**: 每个检测点生成独立报告

## 🔧 技术实现

### 配置兼容性
```python
class Config:
    def __init__(self):
        self.model_name = 'ViT-B-32'
        self.clip_model = 'ViT-B-32' 
        self.clip_pretrained = 'openai'
        self.device = 'cpu'
        self.confidence_threshold = 0.0
        self.log_level = 'ERROR'
        self.save_roi_images = True
        self.output_dir = '.'
```
- 与现有`ProductionToolDetector`完全兼容
- 复用所有检测逻辑和专业报告功能

### 帧处理流程
1. **帧提取** → OpenCV读取视频帧
2. **临时存储** → 保存为临时图片文件
3. **工具检测** → 调用现有检测流程
4. **报告生成** → 生成专业状态报告
5. **文件清理** → 删除临时文件

### 时间控制
- **视频文件**: 基于FPS计算时间位置
- **实时流**: 基于系统时间控制间隔
- **智能采样**: 避免连续相似帧的重复检测

## 📈 性能优化

### 内存管理
- 及时释放OpenCV资源
- 临时文件自动清理
- 帧缓存控制

### 检测效率
- 复用已初始化的检测器
- 智能帧跳过机制
- 可配置检测间隔

## 🚀 扩展能力

### 当前支持的格式
- **视频**: .mp4, .avi, .mov, .mkv, .wmv, .flv, .webm
- **图片**: .jpg, .jpeg, .png, .bmp, .tiff
- **设备**: USB摄像头、内置摄像头

### 未来可扩展
- 网络摄像头流 (RTSP)
- 批量视频文件处理
- 检测结果数据库存储
- 实时告警通知系统

## 🎉 集成效果

### 命令统一性
- 保持与原有命令的一致性
- 相同的输出格式和报告生成
- 无缝的用户体验

### 功能完整性
- 所有检测模式 (detect/check/enhanced) 的功能完全保留
- 专业报告系统完全兼容
- 中文本土化支持完整

### 实用性提升
- 从静态检测扩展到动态监控
- 满足实际工业应用需求
- 提供灵活的配置选项

---

**总结**: 视频流检测功能是对原有系统的重要扩展，在保持所有现有功能的基础上，新增了实时监控和视频分析能力，大大提升了系统的实用价值和应用范围。